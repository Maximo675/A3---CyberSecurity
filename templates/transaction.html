{% extends "base.html" %}

{% block title %}Transação PIX{% endblock %}

{% block content %}

<div class="row justify-content-center">
  <div class="col-md-6">
    <div class="card shadow-sm">
      <div class="card-header bg-info text-white">
        <h3 class="h6 mb-0">Detalhes da Transação</h3>
      </div>
      <div class="card-body">
        <p><strong>ID da Transação:</strong> {{ tx.tx_id }}</p>
        <p><strong>Valor:</strong> R$ {{ amount_str }}</p>
        <p><strong>Método:</strong> {{ tx.method }}</p>
        <p><strong>Status:</strong> <span id="tx-status">{% if tx.status == 'pending' %}<span class="badge bg-warning">Pendente</span>{% elif tx.status == 'confirmed' %}<span class="badge bg-success">Confirmado</span>{% elif tx.status == 'failed' %}<span class="badge bg-danger">Falha</span>{% else %}<span class="badge bg-secondary">{{ tx.status }}</span>{% endif %}</span></p>

        {% if tx.qr_code %}
          <div class="text-center mb-3">
            <img src="{{ tx.qr_code }}" alt="QR Code PIX" class="img-fluid" style="max-width: 320px;" />
          </div>
          <p class="small text-muted">Aponte o aplicativo do seu banco para o QR Code para realizar o pagamento.</p>
        {% else %}
          <p class="text-muted">QR Code não disponível.</p>
        {% endif %}

        <div class="d-grid gap-2">
          <a class="btn btn-secondary" href="{{ url_for('doar_pagamento') }}">Voltar</a>
          {% if tx.status == 'pending' %}
            <button id="simulatePayBtn" class="btn btn-success">Simular Pagamento (Dev)</button>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const btn = document.getElementById('simulatePayBtn');
  if (!btn) return;
  btn.addEventListener('click', async function(e) {
    e.preventDefault();
    try {
      const resp = await fetch('/webhook/payment', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({tx_id: '{{ tx.tx_id }}', status: 'confirmed'})
      });
      if (resp.ok) {
        document.getElementById('tx-status').textContent = 'confirmed';
        alert('Pagamento simulado com sucesso. Status atualizado.');
      } else {
        alert('Falha ao simular pagamento. Veja logs do servidor.');
      }
    } catch (err) {
      console.error(err);
      alert('Erro ao simular pagamento. Veja o console do navegador.');
    }
  });
});
</script>

{% endblock %}
